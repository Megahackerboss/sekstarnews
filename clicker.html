<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Cookie Clicker</title>
    <style>
        :root { --line-color: #ddd; --purchased-color: #28a745; --unlocked-color: #007bff; --disabled-color: #6c757d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #f0f2f5; color: #333; user-select: none; }
        #game-container { max-width: 600px; margin: auto; }
        #cookie-btn { background: url(https://i.ibb.co/RKxrz7P/proxy-image.png) center/cover; width: 150px; height: 150px; border: none; cursor: pointer; border-radius: 50%; transition: transform 0.1s; display: block; margin: 10px auto; }
        #cookie-btn:active { transform: scale(0.95); }
        button { cursor: pointer; padding: 10px 15px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; background-color: #e9e9e9; margin: 5px; transition: background-color 0.2s, border-color 0.2s; }
        button:hover:not(:disabled) { background-color: #ddd; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .upgrade-btn { width: 95%; text-align: center; font-weight: bold; line-height: 1.4; margin-top: 5px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        .new-upgrades-container button { display: none; }
        .new-upgrades-container button.visible { display: block; }
        #prestige-tree { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .pt-node { width: 100%; height: 100%; font-size: 0.75em; border: 2px solid var(--disabled-color); color: var(--disabled-color); background-color: #f8f9fa; border-radius: 4px; padding: 5px; box-sizing: border-box; }
        .pt-node.unlocked { border-color: var(--unlocked-color); color: var(--unlocked-color); }
        .pt-node.purchased { border-color: var(--purchased-color); background-color: #d4edda; color: var(--purchased-color); font-weight: bold; }
        #pt-center { grid-column: 3; grid-row: 3; }
        #pt-b1-1 { grid-column: 3; grid-row: 2; } #pt-b1-2 { grid-column: 3; grid-row: 1; } #pt-b1-3 { grid-column: 4; grid-row: 1; } #pt-b1-4 { grid-column: 5; grid-row: 1; } #pt-b1-5 { grid-column: 5; grid-row: 2; }
        #pt-b2-1 { grid-column: 2; grid-row: 3; } #pt-b2-2 { grid-column: 1; grid-row: 3; } #pt-b2-3 { grid-column: 1; grid-row: 2; } #pt-b2-4 { grid-column: 1; grid-row: 1; } #pt-b2-5 { grid-column: 2; grid-row: 1; }
        #pt-b3-1 { grid-column: 4; grid-row: 3; } #pt-b3-2 { grid-column: 5; grid-row: 3; } #pt-b3-3 { grid-column: 5; grid-row: 4; } #pt-b3-4 { grid-column: 5; grid-row: 5; } #pt-b3-5 { grid-column: 4; grid-row: 5; }
        #pt-b4-1 { grid-column: 3; grid-row: 4; } #pt-b4-2 { grid-column: 3; grid-row: 5; } #pt-b4-3 { grid-column: 2; grid-row: 5; } #pt-b4-4 { grid-column: 1; grid-row: 5; } #pt-b4-5 { grid-column: 1; grid-row: 4; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="game-container">
        <button id="cookie-btn" oncontextmenu="return false;"></button>
        <h3>Ciasteczka: <span id="score">0</span></h3>
        <p style="margin: 5px 0 0;">Klik: <span id="cpc-display">1</span> <small id="crit-info"></small></p>

        <button id="upgrade1-btn" class="upgrade-btn"></button>
        <div class="new-upgrades-container">
            <button id="upgrade2-btn" class="upgrade-btn"></button>
            <button id="upgrade3-btn" class="upgrade-btn"></button>
            <hr>
            <h4>Trwałe Ulepszenia</h4>
            <button id="prestige-autoclicker-btn" class="upgrade-btn"></button>
            <button id="prestige-crit-chance-btn" class="upgrade-btn"></button>
            <button id="prestige-crit-damage-btn" class="upgrade-btn"></button>
        </div>
        
        <hr>
        <div id="prestige-section" style="display: none;">
            <h4>Prestiż</h4>
            <p>Punkty: <span id="prestige-points">0</span></p>
            <button id="prestige-btn"></button>

            <div id="prestige-tree" style="display: none; margin-top: 15px;">
                <button id="pt-center" class="pt-node" data-id="center" title="Better U1 scale (Cost: 1 PP)">Start</button>
                <button id="pt-b1-1" class="pt-node" data-id="b1_1" title="Unlock U2 (Cost: 1 PP)">B1.1</button>
                <button id="pt-b1-2" class="pt-node" data-id="b1_2" title="Ulepszenie 2 daje 1.5% bonusu (Koszt: 2 PP)">B1.2</button>
                <button id="pt-b1-3" class="pt-node" data-id="b1_3" title="Odblokuj Ulepszenie 3 (Koszt: 3 PP)">B1.3</button>
                <button id="pt-b1-4" class="pt-node" data-id="b1_4" title="Ulepszenie 3 jest lepsze (Koszt: 7 PP)">B1.4</button>
                <button id="pt-b1-5" class="pt-node" data-id="b1_5" title="Nieskończone ulepszenie gałęzi 1">B1.INF</button>
                <button id="pt-b2-1" class="pt-node" data-id="b2_1" title="Bonus co 100 ulepszeń (Koszt: 3 PP)">B2.1</button>
                <button id="pt-b2-2" class="pt-node" data-id="b2_2" title="Spadek wzrostu ceny (Koszt: 4 PP)">B2.2</button>
                <button id="pt-b2-3" class="pt-node" data-id="b2_3" title="Spadek wzrostu ceny (Koszt: 6 PP)">B2.3</button>
                <button id="pt-b2-4" class="pt-node" data-id="b2_4" title="Spadek wzrostu ceny (Koszt: 8 PP)">B2.4</button>
                <button id="pt-b2-5" class="pt-node" data-id="b2_5" title="Nieskończony spadek wzrostu ceny">B2.INF</button>
                <button id="pt-b3-1" class="pt-node" data-id="b3_1" title="Odblokuj trwały Auto-Clicker (Koszt: 1 PP)">B3.1</button>
                <button id="pt-b3-2" class="pt-node" data-id="b3_2" title="Auto-Clicker +15% szybciej (Koszt: 2 PP)">B3.2</button>
                <button id="pt-b3-3" class="pt-node" data-id="b3_3" title="Auto-Clicker +25% szybciej (Koszt: 4 PP)">B3.3</button>
                <button id="pt-b3-4" class="pt-node" data-id="b3_4" title="Auto-Clicker wpływa na krytyki (Koszt: 6 PP)">B3.4</button>
                <button id="pt-b3-5" class="pt-node" data-id="b3_5" title="Nieskończona szybkość Auto-Clickera">B3.INF</button>
                <button id="pt-b4-1" class="pt-node" data-id="b4_1" title="Odblokuj Trafienia Krytyczne (Koszt: 1 PP)">B4.1</button>
                <button id="pt-b4-2" class="pt-node" data-id="b4_2" title="Odblokuj trwałe ulepszenie szansy na krytyk (Koszt: 2 PP)">B4.2</button>
                <button id="pt-b4-3" class="pt-node" data-id="b4_3" title="Odblokuj trwałe ulepszenie bonusu krytyka (Koszt: 4 PP)">B4.3</button>
                <button id="pt-b4-4" class="pt-node" data-id="b4_4" title="Bonus do szansy i obrażeń krytycznych (Koszt: 8 PP)">B4.4</button>
                <button id="pt-b4-5" class="pt-node" data-id="b4_5" title="Nieskończone ulepszenie krytyków">B4.INF</button>
            </div>
        </div>
        <hr>
        
        <input id="nickname-input" placeholder="Wpisz swój nick">
        <button id="set-nickname-btn">Ustaw</button>
        
        
        <h4>Ranking Top 10</h4>
        <div id="leaderboard"> <ol id="leaderboard-list"></ol> </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', () => {

        const firebaseConfig = {
        apiKey: "AIzaSyCdc6Xzk_upgrUPX5g6bWAIzgYSQGpyPBY",
        authDomain: "sekstarnews.firebaseapp.com",
        databaseURL: "https://sekstarnews-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sekstarnews"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const GAME_SETTINGS = {
            PRESTIGE_BASE_COST: 1000000,
            PRESTIGE_COST_INCREASE_RATE: 1.07
        };

        let gameState = {};
        const defaultState = {
            cookies: 0,
            upgrade1Level: 0, upgrade1Cost: 10,
            upgrade2Level: 0, upgrade2Cost: 1,
            upgrade3Level: 0, upgrade3Cost: 5000,
            prestigePoints: 0,
            prestigeUpgrades: {},
            prestigeAutoclickerLevel: 0,
            prestigeCritChanceLevel: 0,
            prestigeCritDamageLevel: 0,
            nickname: "Anonim"
            // W przyszłości możesz dodać tu nowe zmienne, np. version: 2
        };
        
        const D = document;
        let autoclickerInterval = null;

        const prestigeTree = {
            'center': { cost: 1, unlocks: ['b1_1', 'b2_1', 'b3_1', 'b4_1'] },
            'b1_1': { cost: 1, unlocks: ['b1_2'] }, 'b1_2': { cost: 2, unlocks: ['b1_3'] }, 'b1_3': { cost: 3, unlocks: ['b1_4'] }, 'b1_4': { cost: 7, unlocks: ['b1_5'] }, 'b1_5': { cost: 5, costIncrease: 3, infinite: true },
            'b2_1': { cost: 3, unlocks: ['b2_2'] }, 'b2_2': { cost: 4, unlocks: ['b2_3'] }, 'b2_3': { cost: 6, unlocks: ['b2_4'] }, 'b2_4': { cost: 8, unlocks: ['b2_5'] }, 'b2_5': { cost: 5, costIncrease: 3, infinite: true },
            'b3_1': { cost: 1, unlocks: ['b3_2'] }, 'b3_2': { cost: 2, unlocks: ['b3_3'] }, 'b3_3': { cost: 4, unlocks: ['b3_4'] }, 'b3_4': { cost: 6, unlocks: ['b3_5'] }, 'b3_5': { cost: 5, costIncrease: 3, infinite: true },
            'b4_1': { cost: 1, unlocks: ['b4_2'] }, 'b4_2': { cost: 2, unlocks: ['b4_3'] }, 'b4_3': { cost: 4, unlocks: ['b4_4'] }, 'b4_4': { cost: 8, unlocks: ['b4_5'] }, 'b4_5': { cost: 5, costIncrease: 3, infinite: true },
        };

        const formatNumber = (num) => {
            num = num || 0;
            if (num < 1000) return Math.floor(num).toLocaleString('pl-PL');
            const suffixes = ["", "K", "M", "B", "T"];
            const i = Math.floor(Math.log10(num) / 3);
            if (i >= suffixes.length) return parseFloat(num.toExponential(2)).toLocaleString('pl-PL');
            const shortNum = (num / Math.pow(1000, i)).toFixed(2);
            return shortNum.replace('.00', '') + ' ' + suffixes[i];
        };
        
        const getPU = (key) => gameState.prestigeUpgrades[key] || 0;

        const sumArithmeticSeries = (n, a, d) => {
            if (n <= 0) return 0;
            return (n / 2) * (2 * a + (n - 1) * d);
        };

        const calculateTotalPrestigesSpent = () => {
            let spent = 0;
            for (const id in prestigeTree) {
                if (prestigeTree[id].infinite) {
                    const level = getPU(id + '_level');
                    spent += sumArithmeticSeries(level, prestigeTree[id].cost, prestigeTree[id].costIncrease);
                } else if (getPU(id)) {
                    spent += prestigeTree[id].cost;
                }
            }
            spent += sumArithmeticSeries(gameState.prestigeAutoclickerLevel, 1, 2);
            spent += sumArithmeticSeries(gameState.prestigeCritChanceLevel, 1, 2);
            spent += sumArithmeticSeries(gameState.prestigeCritDamageLevel, 1, 2);
            return spent;
        };

        const calculatePrestigeCost = () => {
            const totalPrestiges = calculateTotalPrestigesSpent() + gameState.prestigePoints;
            return GAME_SETTINGS.PRESTIGE_BASE_COST * Math.pow(GAME_SETTINGS.PRESTIGE_COST_INCREASE_RATE, totalPrestiges);
        };
        
        const calculateTotalCPC = (isCrit = false) => {
            let base = 1; let bonusFromUpg1 = 0; let bonusMultiplier = 1;
            let bonusPer100 = getPU('b2_1') ? Math.floor(gameState.upgrade1Level / 100) : 0;
            for (let i = 0; i < gameState.upgrade1Level; i++) { bonusFromUpg1 += 1 + Math.floor(i / 10) + bonusPer100; }
            if (getPU('b1_1')) {
                let upg2BonusPerLevel = getPU('b1_2') ? 0.015 : 0.01;
                upg2BonusPerLevel += (getPU('b1_5_level') || 0) * 0.0001;
                bonusMultiplier *= Math.pow(1 + upg2BonusPerLevel, gameState.upgrade2Level);
            }
            let cpc = (base + bonusFromUpg1) * bonusMultiplier;
            if (getPU('b1_3')) {
                let upg3Multiplier = 1; let upg3Bonus = getPU('b1_4') ? 0.11 : 0.1;
                upg3Bonus += (getPU('b1_5_level') || 0) * 0.02;
                upg3Multiplier += gameState.upgrade3Level * upg3Bonus;
                cpc *= upg3Multiplier;
            }
            if (isCrit) {
                let critBonus = 0.10 + (getPU('b4_4') ? 0.05 : 0) + (gameState.prestigeCritDamageLevel * 0.02) + ((getPU('b4_5_level') || 0) * 0.01);
                cpc *= (1 + critBonus);
            }
            return cpc;
        };

        const handleCookieClick = (isAuto = false) => {
            let critChance = 0;
            if (getPU('b4_1')) {
                critChance += 0.01 + (getPU('b4_4') ? 0.02 : 0) + (gameState.prestigeCritChanceLevel * 0.001) + ((getPU('b4_5_level') || 0) * 0.001);
            }
            let isCrit = Math.random() < critChance;
            if (isAuto && !getPU('b3_4')) isCrit = false;
            let cpc = calculateTotalCPC(isCrit);
            gameState.cookies += cpc;
            updateUI();
        };

        const updateUI = () => {
            D.getElementById('score').textContent = formatNumber(gameState.cookies);
            D.getElementById('cpc-display').textContent = formatNumber(calculateTotalCPC());
            if (getPU('b4_1')) {
                let critChance = 0.01 + (getPU('b4_4') ? 0.02 : 0) + (gameState.prestigeCritChanceLevel * 0.001) + ((getPU('b4_5_level') || 0) * 0.001);
                D.getElementById('crit-info').textContent = `(${(critChance * 100).toFixed(1)}% szans na krytyk)`;
            } else { D.getElementById('crit-info').textContent = ''; }
            
            D.getElementById('upgrade1-btn').textContent = `Ulepszenie 1 (Poziom: ${formatNumber(gameState.upgrade1Level)}) Koszt: ${formatNumber(gameState.upgrade1Cost)}`;
            const upg2Btn = D.getElementById('upgrade2-btn'); upg2Btn.classList.toggle('visible', getPU('b1_1'));
            upg2Btn.textContent = `Ulepszenie 2 (Poziom: ${formatNumber(gameState.upgrade2Level)}) Koszt: ${formatNumber(gameState.upgrade2Cost)}`;
            const upg3Btn = D.getElementById('upgrade3-btn'); upg3Btn.classList.toggle('visible', getPU('b1_3'));
            upg3Btn.textContent = `Ulepszenie 3 (Poziom: ${formatNumber(gameState.upgrade3Level)}) Koszt: ${formatNumber(gameState.upgrade3Cost)}`;

            const pacBtn = D.getElementById('prestige-autoclicker-btn'); pacBtn.classList.toggle('visible', getPU('b3_1'));
            let pacCost = 1 + (gameState.prestigeAutoclickerLevel * 2);
            pacBtn.textContent = `Trwały Auto-Clicker (${gameState.prestigeAutoclickerLevel} klik/s) Koszt: ${formatNumber(pacCost)} PP`;
            
            const pccBtn = D.getElementById('prestige-crit-chance-btn'); pccBtn.classList.toggle('visible', getPU('b4_2'));
            let pccCost = 1 + (gameState.prestigeCritChanceLevel * 2);
            pccBtn.textContent = `+0.1% szansy na krytyk (Poziom: ${gameState.prestigeCritChanceLevel}) Koszt: ${formatNumber(pccCost)} PP`;

            const pcdBtn = D.getElementById('prestige-crit-damage-btn'); pcdBtn.classList.toggle('visible', getPU('b4_3'));
            let pcdCost = 1 + (gameState.prestigeCritDamageLevel * 2);
            pcdBtn.textContent = `+2% bonusu krytyka (Poziom: ${gameState.prestigeCritDamageLevel}) Koszt: ${formatNumber(pcdCost)} PP`;
            
            const hasPrestiged = Object.keys(gameState.prestigeUpgrades).length > 0 || gameState.prestigePoints > 0;
            const currentPrestigeCost = calculatePrestigeCost();
            D.getElementById('prestige-section').style.display = gameState.cookies >= currentPrestigeCost || hasPrestiged ? 'block' : 'none';
            D.getElementById('prestige-points').textContent = formatNumber(gameState.prestigePoints);
            D.getElementById('prestige-btn').textContent = `Prestiż (Koszt: ${formatNumber(currentPrestigeCost)})`;
            D.getElementById('prestige-tree').style.display = hasPrestiged ? 'grid' : 'none';
            
            document.querySelectorAll('.pt-node').forEach(btn => {
                const id = btn.dataset.id; const node = prestigeTree[id]; if (!node) return;
                let cost = node.cost; if (node.infinite) { cost += (getPU(id + '_level') || 0) * node.costIncrease; }
                btn.disabled = true; btn.classList.remove('unlocked', 'purchased');
                if(getPU(id) && !node.infinite) { btn.classList.add('purchased'); } else if (node.infinite) { btn.classList.remove('purchased'); }
                let canUnlock = id === 'center' || Object.keys(prestigeTree).some(p_id => prestigeTree[p_id].unlocks?.includes(id) && getPU(p_id));
                if (canUnlock && !(getPU(id) && !node.infinite)) {
                    btn.classList.add('unlocked');
                    if (gameState.prestigePoints >= cost) { btn.disabled = false; }
                }
                btn.title = btn.title.split('(Koszt:')[0] + `(Koszt: ${cost} PP)`;
                if (node.infinite) btn.title += ` | Poziom: ${getPU(id + '_level') || 0}`;
            });
        };

        const saveGame = () => localStorage.setItem('clickerGameSave', JSON.stringify(gameState));
        
        // --- ZAKTUALIZOWANA, INTELIGENTNA FUNKCJA WCZYTYWANIA ---
        const loadGame = () => {
            let savedData; 
            let daneZalogowanegoUzytkownika = null;
            try { 
                savedData = JSON.parse(localStorage.getItem('clickerGameSave')); 
            } catch (e) { 
                savedData = null; 
            }
            
            // Automatyczna migracja: jeśli stary zapis istnieje i ma przestarzałą zmienną, usuń ją
            if (savedData && savedData.prestigeCost !== undefined) {
                delete savedData.prestigeCost;
            }

            // Stwórz stan gry, łącząc domyślne wartości z zapisanymi (nowe zmienne zostaną dodane automatycznie)
            gameState = { ...defaultState, ...savedData };

            // Upewnij się, że obiekty wewnątrz też są poprawnie połączone (ważne dla prestigeUpgrades)
            if (savedData && savedData.prestigeUpgrades) {
                gameState.prestigeUpgrades = { ...defaultState.prestigeUpgrades, ...savedData.prestigeUpgrades };
            }

            D.getElementById('nickname-input').value = gameState.nickname;
            setupAutoclicker();
            updateUI();
        };

        const setupAutoclicker = () => {
            if (autoclickerInterval) clearInterval(autoclickerInterval);
            if (getPU('b3_1') && gameState.prestigeAutoclickerLevel > 0) {
                let interval = 1000 / gameState.prestigeAutoclickerLevel;
                if (getPU('b3_2')) interval *= 0.85; if (getPU('b3_3')) interval *= 0.75;
                interval /= (1 + (getPU('b3_5_level') || 0) * 0.05);
                autoclickerInterval = setInterval(() => handleCookieClick(true), Math.max(50, interval));
            }
        };

        D.getElementById('game-container').addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            if (target.classList.contains('pt-node')) {
                const prestigeId = target.dataset.id;
                const node = prestigeTree[prestigeId];
                const isInfinite = node.infinite;
                const levelKey = prestigeId + '_level';
                let cost = node.cost;
                if (isInfinite) { cost += (getPU(levelKey) || 0) * node.costIncrease; }
                if (gameState.prestigePoints >= cost) {
                    gameState.prestigePoints -= cost;
                    if (isInfinite) { gameState.prestigeUpgrades[levelKey] = (getPU(levelKey) || 0) + 1; } 
                    else { gameState.prestigeUpgrades[prestigeId] = 1; }
                    updateUI();
                }
                return;
            }

            switch (target.id) {
                case 'cookie-btn': handleCookieClick(); break;
                case 'upgrade1-btn':
                    if (gameState.cookies >= gameState.upgrade1Cost) {
                        gameState.cookies -= gameState.upgrade1Cost;
                        let decayRate = 0.01; if (getPU('center')) decayRate = 0.0105; if (getPU('b2_2')) decayRate = 0.011; if (getPU('b2_3')) decayRate = 0.0112; if (getPU('b2_4')) decayRate = 0.0113;
                        decayRate += (getPU('b2_5_level') || 0) * 0.00004;
                        const decayBase = 1 - decayRate;
                        const multiplier = 1 + (0.1 * Math.pow(decayBase, gameState.upgrade1Level));
                        gameState.upgrade1Cost *= multiplier;
                        gameState.upgrade1Level++;
                        updateUI();
                    }
                    break;
                case 'upgrade2-btn':
                    if (gameState.cookies >= gameState.upgrade2Cost) {
                        gameState.cookies -= gameState.upgrade2Cost;
                        let costMultiplier = getPU('b1_2') ? 5 : 10;
                        gameState.upgrade2Cost *= costMultiplier;
                        gameState.upgrade2Level++;
                        updateUI();
                    }
                    break;
                case 'upgrade3-btn':
                    if (gameState.cookies >= gameState.upgrade3Cost) {
                        gameState.cookies -= gameState.upgrade3Cost;
                        let costMultiplier = getPU('b1_4') ? 7 : 8;
                        costMultiplier -= (getPU('b1_5_level') || 0) * 0.1;
                        gameState.upgrade3Cost *= Math.max(1.1, costMultiplier);
                        gameState.upgrade3Level++;
                        updateUI();
                    }
                    break;
                case 'prestige-autoclicker-btn':
                    let pacCost = 1 + (gameState.prestigeAutoclickerLevel * 2);
                    if (gameState.prestigePoints >= pacCost) { gameState.prestigePoints -= pacCost; gameState.prestigeAutoclickerLevel++; setupAutoclicker(); updateUI(); }
                    break;
                case 'prestige-crit-chance-btn':
                    let pccCost = 1 + (gameState.prestigeCritChanceLevel * 2);
                    if (gameState.prestigePoints >= pccCost) { gameState.prestigePoints -= pccCost; gameState.prestigeCritChanceLevel++; updateUI(); }
                    break;
                case 'prestige-crit-damage-btn':
                    let pcdCost = 1 + (gameState.prestigeCritDamageLevel * 2);
                    if (gameState.prestigePoints >= pcdCost) { gameState.prestigePoints -= pcdCost; gameState.prestigeCritDamageLevel++; updateUI(); }
                    break;
                case 'prestige-btn':
                    if (gameState.cookies >= calculatePrestigeCost()) {
                        gameState.prestigePoints++;
                        const persistentState = { prestigePoints: gameState.prestigePoints, prestigeUpgrades: gameState.prestigeUpgrades, prestigeAutoclickerLevel: gameState.prestigeAutoclickerLevel, prestigeCritChanceLevel: gameState.prestigeCritChanceLevel, prestigeCritDamageLevel: gameState.prestigeCritDamageLevel, nickname: gameState.nickname };
                        gameState = { ...defaultState, ...persistentState };
                        setupAutoclicker(); updateUI();
                    }
                    break;
                
                case 'set-nickname-btn':
                    const nick = D.getElementById('nickname-input').value.trim();
                    if (nick) gameState.nickname = nick; saveGame();
                    break;
            }
        });
        
        const updateLeaderboard = () => {
            if (gameState.nickname && gameState.nickname !== 'Anonim') {
                const safeNickname = gameState.nickname.replace(/[.#$\[\]]/g, '_');
                database.ref('leaderboard/' + safeNickname).set({ nn: gameState.nickname, c: Math.floor(gameState.cookies || 0) });
            }
        };
        database.ref('leaderboard').orderByChild('c').limitToLast(10).on('value', snapshot => {
            const list = D.getElementById('leaderboard-list'); list.innerHTML = ''; const scores = [];
            snapshot.forEach(child => { scores.push(child.val()) });
            scores.reverse().forEach(player => { const li = D.createElement('li'); li.textContent = `${player.nn}: ${formatNumber(player.c)}`; list.appendChild(li); });
        });

        loadGame();
        setInterval(saveGame, 5000);
        setInterval(updateLeaderboard, 30000);




/**
 * Ta funkcja jest publiczna (dostępna dla rodzica) i czeka na wywołanie.
 * Przyjmuje dwa argumenty i zapisuje je w lokalnej zmiennej.
 */
function odbierzDaneUzytkownika(otrzymanyUid, otrzymanyNick) {
    console.log(`Iframe otrzymał dane: UID=${otrzymanyUid}, Nick=${otrzymanyNick}`);

    // Zapisujemy otrzymane dane do lokalnego obiektu
    daneZalogowanegoUzytkownika = {
        uid: otrzymanyUid,
        nick: otrzymanyNick
    };

    // Od tego momentu możesz używać obiektu 'daneZalogowanegoUzytkownika'
    // w całej reszcie swojego kodu w iframe.
}
   
    });





        


    </script>
</body>
</html>
