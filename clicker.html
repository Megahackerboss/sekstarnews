<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Cookie Clicker</title>
    <style>
        :root { --line-color: #ddd; --purchased-color: #28a745; --unlocked-color: #007bff; --disabled-color: #6c757d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #f0f2f5; color: #333; user-select: none; }
        #game-container { max-width: 600px; margin: auto; }
        #cookie-btn { background: url(https://i.ibb.co/RKxrz7P/proxy-image.png) center/cover; width: 150px; height: 150px; border: none; cursor: pointer; border-radius: 50%; transition: transform 0.1s; display: block; margin: 10px auto; }
        #cookie-btn:active { transform: scale(0.95); }
        button { cursor: pointer; padding: 10px 15px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; background-color: #e9e9e9; margin: 5px; transition: background-color 0.2s, border-color 0.2s; }
        button:hover:not(:disabled) { background-color: #ddd; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .upgrade-btn { width: 95%; text-align: center; font-weight: bold; line-height: 1.4; margin-top: 5px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        .new-upgrades-container button { display: none; }
        .new-upgrades-container button.visible { display: block; }
        #prestige-tree { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .pt-node { width: 100%; height: 100%; font-size: 0.75em; border: 2px solid var(--disabled-color); color: var(--disabled-color); background-color: #f8f9fa; border-radius: 4px; padding: 5px; box-sizing: border-box; }
        .pt-node.unlocked { border-color: var(--unlocked-color); color: var(--unlocked-color); }
        .pt-node.purchased { border-color: var(--purchased-color); background-color: #d4edda; color: var(--purchased-color); font-weight: bold; }
        #pt-center { grid-column: 3; grid-row: 3; }
        #pt-b1-1 { grid-column: 3; grid-row: 2; } #pt-b1-2 { grid-column: 3; grid-row: 1; } #pt-b1-3 { grid-column: 4; grid-row: 1; } #pt-b1-4 { grid-column: 5; grid-row: 1; } #pt-b1-5 { grid-column: 5; grid-row: 2; }
        #pt-b2-1 { grid-column: 2; grid-row: 3; } #pt-b2-2 { grid-column: 1; grid-row: 3; } #pt-b2-3 { grid-column: 1; grid-row: 2; } #pt-b2-4 { grid-column: 1; grid-row: 1; } #pt-b2-5 { grid-column: 2; grid-row: 1; }
        #pt-b3-1 { grid-column: 4; grid-row: 3; } #pt-b3-2 { grid-column: 5; grid-row: 3; } #pt-b3-3 { grid-column: 5; grid-row: 4; } #pt-b3-4 { grid-column: 5; grid-row: 5; } #pt-b3-5 { grid-column: 4; grid-row: 5; }
        #pt-b4-1 { grid-column: 3; grid-row: 4; } #pt-b4-2 { grid-column: 3; grid-row: 5; } #pt-b4-3 { grid-column: 2; grid-row: 5; } #pt-b4-4 { grid-column: 1; grid-row: 5; } #pt-b4-5 { grid-column: 1; grid-row: 4; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #controls { margin-top: 10px; }
    </style>
</head>
<body>
    <div id="game-container">
        <button id="cookie-btn" oncontextmenu="return false;"></button>
        <h3><span class="lang" data-key="cookies">Ciasteczka</span>: <span id="score">0</span></h3>
        <p style="margin: 5px 0 0;"><span class="lang" data-key="cpc">Klik</span>: <span id="cpc-display">1</span> <small id="crit-info"></small></p>

        <button id="upgrade1-btn" class="upgrade-btn"></button>
        <div class="new-upgrades-container">
            <button id="upgrade2-btn" class="upgrade-btn"></button>
            <button id="upgrade3-btn" class="upgrade-btn"></button>
            <hr>
            <h4 class="lang" data-key="permanent_upgrades">Trwałe Ulepszenia</h4>
            <button id="prestige-autoclicker-btn" class="upgrade-btn"></button>
            <button id="prestige-crit-chance-btn" class="upgrade-btn"></button>
            <button id="prestige-crit-damage-btn" class="upgrade-btn"></button>
        </div>
        
        <hr>
        <div id="prestige-section" style="display: none;">
            <h4 class="lang" data-key="prestige">Prestiż</h4>
            <p><span class="lang" data-key="points">Punkty</span>: <span id="prestige-points">0</span></p>
            <button id="prestige-btn"></button>

            <div id="prestige-tree" style="display: none; margin-top: 15px;">
                <button id="pt-center" class="pt-node" data-id="center" data-title-key="pt_center_title"></button>
                <button id="pt-b1-1" class="pt-node" data-id="b1_1" data-title-key="pt_b1_1_title"></button>
                <button id="pt-b1-2" class="pt-node" data-id="b1_2" data-title-key="pt_b1_2_title"></button>
                <button id="pt-b1-3" class="pt-node" data-id="b1_3" data-title-key="pt_b1_3_title"></button>
                <button id="pt-b1-4" class="pt-node" data-id="b1_4" data-title-key="pt_b1_4_title"></button>
                <button id="pt-b1-5" class="pt-node" data-id="b1_5" data-title-key="pt_b1_5_title"></button>
                <button id="pt-b2-1" class="pt-node" data-id="b2_1" data-title-key="pt_b2_1_title"></button>
                <button id="pt-b2-2" class="pt-node" data-id="b2_2" data-title-key="pt_b2_2_title"></button>
                <button id="pt-b2-3" class="pt-node" data-id="b2_3" data-title-key="pt_b2_3_title"></button>
                <button id="pt-b2-4" class="pt-node" data-id="b2_4" data-title-key="pt_b2_4_title"></button>
                <button id="pt-b2-5" class="pt-node" data-id="b2_5" data-title-key="pt_b2_5_title"></button>
                <button id="pt-b3-1" class="pt-node" data-id="b3_1" data-title-key="pt_b3_1_title"></button>
                <button id="pt-b3-2" class="pt-node" data-id="b3_2" data-title-key="pt_b3_2_title"></button>
                <button id="pt-b3-3" class="pt-node" data-id="b3_3" data-title-key="pt_b3_3_title"></button>
                <button id="pt-b3-4" class="pt-node" data-id="b3_4" data-title-key="pt_b3_4_title"></button>
                <button id="pt-b3-5" class="pt-node" data-id="b3_5" data-title-key="pt_b3_5_title"></button>
                <button id="pt-b4-1" class="pt-node" data-id="b4_1" data-title-key="pt_b4_1_title"></button>
                <button id="pt-b4-2" class="pt-node" data-id="b4_2" data-title-key="pt_b4_2_title"></button>
                <button id="pt-b4-3" class="pt-node" data-id="b4_3" data-title-key="pt_b4_3_title"></button>
                <button id="pt-b4-4" class="pt-node" data-id="b4_4" data-title-key="pt_b4_4_title"></button>
                <button id="pt-b4-5" class="pt-node" data-id="b4_5" data-title-key="pt_b4_5_title"></button>
            </div>
        </div>
        <hr>
        
        <div id="controls">
            <input id="nickname-input" placeholder="Wpisz swój nick">
            <button id="set-nickname-btn" class="lang" data-key="set_nickname_btn">Ustaw</button>
            <button id="reset-btn" class="lang" data-key="reset_btn">Resetuj</button>
            <button id="lang-switcher">Switch to English</button>
        </div>
        
        <h4 class="lang" data-key="leaderboard">Ranking Top 10</h4>
        <div id="leaderboard"> <ol id="leaderboard-list"></ol> </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', () => {
        console.log("LOG: DOM Loaded. Initializing script...");

        const firebaseConfig = {
        apiKey: "AIzaSyCdc6Xzk_upgrUPX5g6bWAIzgYSQGpyPBY",
        authDomain: "sekstarnews.firebaseapp.com",
        databaseURL: "https://sekstarnews-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sekstarnews"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        console.log("LOG: Firebase initialized.");
        
        const GAME_SETTINGS = {
            PRESTIGE_BASE_COST: 1000000,
            PRESTIGE_COST_INCREASE_RATE: 1.07,
            UPGRADE1_CAP: 1000,
            UPGRADE1_MIN_MULTIPLIER_EFFECT: 0.005
        };
        
        const translations = { /* ... (bez zmian) ... */ };
        let gameState = {};
        const defaultState = {
            cookies: 0,
            upgrade1Level: 0, upgrade1Cost: 10,
            upgrade2Level: 0, upgrade2Cost: 1,
            upgrade3Level: 0, upgrade3Cost: 5000,
            prestigePoints: 0,
            prestigeUpgrades: {},
            prestigeAutoclickerLevel: 0,
            prestigeCritChanceLevel: 0,
            prestigeCritDamageLevel: 0,
            nickname: "Anonim",
            language: 'pl'
        };
        
        const D = document;
        let autoclickerInterval = null;
        const prestigeTree = { /* ... (bez zmian) ... */ };
        const t = (key, ...args) => { /* ... (bez zmian) ... */ };
        const formatNumber = (num) => { /* ... (bez zmian) ... */ };
        const getPU = (key) => gameState.prestigeUpgrades[key] || 0;
        const sumArithmeticSeries = (n, a, d) => { /* ... (bez zmian) ... */ };
        const calculateTotalPrestigesSpent = () => { /* ... (bez zmian) ... */ };
        const calculatePrestigeCost = () => { /* ... (bez zmian) ... */ };
        const calculateTotalCPC = (isCrit = false) => { /* ... (bez zmian) ... */ };

        const handleCookieClick = (isAuto = false) => {
            let critChance = 0;
            if (getPU('b4_1')) {
                critChance += 0.01 + (getPU('b4_4') ? 0.02 : 0) + (gameState.prestigeCritChanceLevel * 0.001) + ((getPU('b4_5_level') || 0) * 0.001);
            }
            let isCrit = Math.random() < critChance;
            if (isAuto && !getPU('b3_4')) isCrit = false;
            let cpc = calculateTotalCPC(isCrit);
            gameState.cookies += cpc;
            updateUI();
        };

        const updateUI = () => { /* ... (bez zmian, oprócz poprawki z 'hasPrestiged') ... */ };
        const saveGame = () => {
            localStorage.setItem('clickerGameSave', JSON.stringify(gameState));
            console.log("LOG: Game Saved.");
        };
        
        // --- NOWA, BEZPIECZNA FUNKCJA WCZYTYWANIA Z LOGAMI ---
        const loadGame = () => {
            console.log("LOG: Executing loadGame...");
            // Zawsze zaczynaj od pełnej, czystej kopii domyślnego stanu, aby zagwarantować, że wszystkie pola istnieją.
            gameState = JSON.parse(JSON.stringify(defaultState));
            
            try {
                const savedDataString = localStorage.getItem('clickerGameSave');
                if (savedDataString) {
                    console.log("LOG: Saved data found in localStorage.");
                    const savedData = JSON.parse(savedDataString);

                    // Bezpiecznie połącz zapisane dane z czystym stanem.
                    // To zapewni, że nowe zmienne dodane w `defaultState` zostaną zachowane, jeśli nie ma ich w zapisie.
                    gameState = { ...gameState, ...savedData };

                    // Upewnij się, że zagnieżdżone obiekty są poprawnie połączone.
                    if (savedData.prestigeUpgrades) {
                        gameState.prestigeUpgrades = { ...defaultState.prestigeUpgrades, ...savedData.prestigeUpgrades };
                    }
                } else {
                    console.log("LOG: No saved data found. Starting fresh.");
                }
            } catch (error) {
                console.error("LOG: Failed to load or parse saved data. Starting fresh to prevent crash.", error);
            }
            
            console.log("LOG: Game state successfully initialized:", gameState);
            D.getElementById('nickname-input').value = gameState.nickname;
            setupAutoclicker();
            updateUI();
            console.log("LOG: Initial UI update complete.");
        };

        const setupAutoclicker = () => { /* ... (bez zmian) ... */ };
        
        D.getElementById('game-container').addEventListener('click', (event) => { /* ... (bez zmian) ... */ });
        
        const updateLeaderboard = () => {
             if (gameState.nickname && gameState.nickname !== 'Anonim') {
                const safeNickname = gameState.nickname.replace(/[.#$\[\]]/g, '_');
                database.ref('leaderboard/' + safeNickname).set({ nn: gameState.nickname, c: Math.floor(gameState.cookies || 0) });
            }
        };
        database.ref('leaderboard').orderByChild('c').limitToLast(10).on('value', snapshot => {
            console.log("LOG: Leaderboard data received from Firebase.");
            const list = D.getElementById('leaderboard-list'); list.innerHTML = ''; const scores = [];
            snapshot.forEach(child => { scores.push(child.val()) });
            scores.reverse().forEach(player => { const li = D.createElement('li'); li.textContent = `${player.nn}: ${formatNumber(player.c)}`; list.appendChild(li); });
        });

        // --- INICJALIZACJA GRY ---
        loadGame();
        setInterval(saveGame, 5000);
        setInterval(updateLeaderboard, 30000);
        console.log("LOG: Script initialization complete. Game is running.");
    });
    </script>
</body>
</html>
