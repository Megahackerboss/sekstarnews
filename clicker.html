<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Cookie Clicker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #f7f7f7; color: #333; user-select: none; }
        #game-container { max-width: 500px; margin: auto; }
        #cookie-btn { background: url(https://i.ibb.co/RKxrz7P/proxy-image.png) center/cover; width: 150px; height: 150px; border: none; cursor: pointer; border-radius: 50%; transition: transform 0.1s; display: block; margin: 10px auto; }
        #cookie-btn:active { transform: scale(0.95); }
        button { cursor: pointer; padding: 10px 15px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; background-color: #e9e9e9; margin: 5px; }
        button:hover:not(:disabled) { background-color: #ddd; }
        button:disabled { cursor: not-allowed; color: #999; }
        #upgrade-btn { width: 95%; text-align: center; font-weight: bold; line-height: 1.4; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        .prestige-tree { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .pt-upgrade { width: 90%; text-align: left; padding: 8px; margin: 4px auto; display: block; }
        .pt-upgrade.purchased { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        #leaderboard ol { text-align: left; padding-left: 30px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="game-container">
        <button id="cookie-btn" oncontextmenu="return false;"></button>
        <h3>Ciasteczka: <span id="score">0</span></h3>
        <p style="margin: 5px 0 0;">Łącznie za klik: <span id="cpc-display">1</span></p>
        <p style="margin: 0 0 10px;">Poziom ulepszeń: <span id="upgrade-level-display">0</span></p>

        <button id="upgrade-btn">Ulepsz</button>
        <hr>
        <div id="prestige-section" style="display: none;">
            <h4>Prestiż</h4>
            <p>Punkty: <span id="prestige-points">0</span></p>
            <button id="prestige-btn">Prestiż</button>

            <div class="prestige-tree" id="prestige-tree" style="display: none; margin-top: 15px;">
                <h4>Drzewko Umiejętności</h4>
                <button id="pu-start-bonus" class="pt-upgrade" data-cost="1">Zacznij z 1000 ciastek (Koszt: 1 PP)</button>
                <button id="pu-cheaper-upgrades" class="pt-upgrade" data-cost="1" disabled>Ulepszenia tańsze o 5% (Koszt: 1 PP)</button>
                <button id="pu-prestige-boost" class="pt-upgrade" data-cost="2" disabled>Prestiż daje 10% więcej PP (Koszt: 2 PP)</button>
                <button id="pu-autoclicker" class="pt-upgrade" data-cost="3" disabled>Odblokuj Auto-Clicker (1 klik/s) (Koszt: 3 PP)</button>
                <hr>
                <p>Ulepszenie Nieskończone:</p>
                <button id="pu-base-cpc" class="pt-upgrade" data-cost="1" disabled>+1 do bazy/klik (Koszt: 1 PP) | Poziom: <span id="pu-base-cpc-level">0</span></button>
            </div>
        </div>
        <hr>
        
        <input id="nickname-input" placeholder="Wpisz swój nick">
        <button id="set-nickname-btn">Ustaw</button>
        <button id="reset-btn">Resetuj</button>
        
        <h4>Ranking Top 10</h4>
        <div id="leaderboard">
            <ol id="leaderboard-list"></ol>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {

            const firebaseConfig = {
                apiKey: "TWOJ_API_KEY",
                authDomain: "TWOJ_AUTH_DOMAIN",
                databaseURL: "TWOJA_DATABASE_URL",
                projectId: "TWOJ_PROJECT_ID"
            };
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            let gameState = {};
            const defaultState = {
                cookies: 0, upgradeLevel: 0, upgradeCost: 10,
                prestigePoints: 0, prestigeCost: 1000000,
                prestigeUpgrades: { startBonus: 0, cheaperUpgrades: 0, prestigeBoost: 0, autoclicker: 0, baseCpc: 0 },
                nickname: "Anonim"
            };
            
            const D = document;
            let autoclickerInterval = null;

            const formatNumber = (num) => {
                num = Math.floor(num || 0);
                if (num < 1000) return num.toLocaleString('pl-PL');
                const suffixes = ["", "K", "M", "B", "T"];
                const i = Math.floor(Math.log10(num) / 3);
                const shortNum = (num / Math.pow(1000, i)).toFixed(2);
                return shortNum.replace('.00', '') + ' ' + suffixes[i];
            };

            const calculateBonusFromUpgrades = (level) => {
                let bonus = 0;
                for (let i = 0; i < level; i++) { bonus += 1 + Math.floor(i / 10); }
                return bonus;
            };

            const calculateTotalCPC = () => {
                let base = 1 + gameState.prestigeUpgrades.baseCpc;
                let bonus = calculateBonusFromUpgrades(gameState.upgradeLevel);
                let total = base + bonus;
                if (gameState.prestigeUpgrades.autoclicker) total *= 1.05; // Mały pasywny bonus z autoclickera
                return total;
            };

            const updateUI = () => {
                D.getElementById('score').textContent = formatNumber(gameState.cookies);
                D.getElementById('cpc-display').textContent = formatNumber(calculateTotalCPC());
                D.getElementById('upgrade-level-display').textContent = gameState.upgradeLevel;
                
                const nextUpgradeBonus = 1 + Math.floor(gameState.upgradeLevel / 10);
                const currentTotalBonus = calculateBonusFromUpgrades(gameState.upgradeLevel);
                D.getElementById('upgrade-btn').innerHTML = `Ulepsz (+${formatNumber(nextUpgradeBonus)}) Koszt: ${formatNumber(gameState.upgradeCost)}<br><small>Obecny bonus z ulepszeń: ${formatNumber(currentTotalBonus)}</small>`;
                
                const prestigeSection = D.getElementById('prestige-section');
                prestigeSection.style.display = gameState.cookies >= gameState.prestigeCost || gameState.prestigePoints > 0 ? 'block' : 'none';
                D.getElementById('prestige-points').textContent = formatNumber(gameState.prestigePoints);
                D.getElementById('prestige-btn').textContent = `Prestiż (Koszt: ${formatNumber(gameState.prestigeCost)})`;

                // Update Prestige Tree
                const pt = D.getElementById('prestige-tree');
                pt.style.display = gameState.prestigePoints > 0 || Object.values(gameState.prestigeUpgrades).some(v => v > 0) ? 'block' : 'none';

                const upgrades = [
                    { id: 'pu-start-bonus', key: 'startBonus', unlocks: 'pu-cheaper-upgrades' },
                    { id: 'pu-cheaper-upgrades', key: 'cheaperUpgrades', unlocks: 'pu-prestige-boost' },
                    { id: 'pu-prestige-boost', key: 'prestigeBoost', unlocks: 'pu-autoclicker' },
                    { id: 'pu-autoclicker', key: 'autoclicker', unlocks: 'pu-base-cpc' }
                ];

                upgrades.forEach(u => {
                    const btn = D.getElementById(u.id);
                    if (gameState.prestigeUpgrades[u.key]) {
                        btn.classList.add('purchased');
                        btn.disabled = true;
                        if (u.unlocks) D.getElementById(u.unlocks).disabled = false;
                    }
                    if (gameState.prestigePoints < parseInt(btn.dataset.cost)) {
                        if(!gameState.prestigeUpgrades[u.key]) btn.disabled = true;
                    }
                });
                
                const baseCpcBtn = D.getElementById('pu-base-cpc');
                const baseCpcCost = 1 + gameState.prestigeUpgrades.baseCpc;
                baseCpcBtn.dataset.cost = baseCpcCost;
                baseCpcBtn.textContent = `+1 do bazy/klik (Koszt: ${baseCpcCost} PP) | Poziom: ${gameState.prestigeUpgrades.baseCpc}`;
                if (gameState.prestigePoints < baseCpcCost) baseCpcBtn.disabled = true;
            };

            const saveGame = () => {
                localStorage.setItem('clickerGameSave', JSON.stringify(gameState));
                if (gameState.nickname && gameState.nickname !== 'Anonim') {
                    const safeNickname = gameState.nickname.replace(/[.#$\[\]]/g, '_');
                    database.ref('leaderboard/' + safeNickname).set({
                        nn: gameState.nickname,
                        c: Math.floor(gameState.cookies || 0)
                    });
                }
            };

            const loadGame = () => {
                let savedData;
                try {
                    savedData = JSON.parse(localStorage.getItem('clickerGameSave'));
                    // Prosta migracja dla starych zapisów
                    if (savedData && !savedData.prestigeUpgrades) {
                        savedData.prestigeUpgrades = { ...defaultState.prestigeUpgrades };
                    }
                } catch (e) { savedData = null; }
                gameState = { ...defaultState, ...savedData };
                
                D.getElementById('nickname-input').value = gameState.nickname;
                if (gameState.prestigeUpgrades.autoclicker) setupAutoclicker();
                updateUI();
            };

            const setupAutoclicker = () => {
                if (autoclickerInterval) clearInterval(autoclickerInterval);
                autoclickerInterval = setInterval(() => {
                    gameState.cookies += calculateTotalCPC();
                    updateUI();
                }, 1000);
            };

            // === OBSŁUGA ZDARZEŃ ===
            D.getElementById('cookie-btn').onclick = () => {
                gameState.cookies += calculateTotalCPC();
                updateUI();
            };

            D.getElementById('upgrade-btn').onclick = () => {
                let costReduction = gameState.prestigeUpgrades.cheaperUpgrades ? 0.95 : 1;
                let currentCost = gameState.upgradeCost * costReduction;

                if (gameState.cookies >= currentCost) {
                    gameState.cookies -= currentCost;
                    let multiplier = 1 + (0.1 * Math.pow(0.99, gameState.upgradeLevel));
                    gameState.upgradeCost *= multiplier;
                    gameState.upgradeLevel++;
                    updateUI();
                }
            };
            
            D.getElementById('prestige-btn').onclick = () => {
                if (gameState.cookies >= gameState.prestigeCost) {
                    let prestigeGain = 1;
                    if (gameState.prestigeUpgrades.prestigeBoost) prestigeGain *= 1.1;
                    gameState.prestigePoints += Math.floor(prestigeGain);
                    
                    const prestigeState = {
                        prestigePoints: gameState.prestigePoints,
                        prestigeUpgrades: gameState.prestigeUpgrades,
                        nickname: gameState.nickname
                    };
                    gameState = { ...defaultState, ...prestigeState };
                    gameState.prestigeCost *= 1.20;
                    if (gameState.prestigeUpgrades.startBonus) gameState.cookies = 1000;
                    
                    if (autoclickerInterval) clearInterval(autoclickerInterval);
                    if (gameState.prestigeUpgrades.autoclicker) setupAutoclicker();

                    updateUI();
                }
            };

            function handlePrestigeUpgrade(id, key, unlocks) {
                const btn = D.getElementById(id);
                const cost = parseInt(btn.dataset.cost);
                if (gameState.prestigePoints >= cost) {
                    gameState.prestigePoints -= cost;
                    gameState.prestigeUpgrades[key] = 1;
                    if (key === 'autoclicker') setupAutoclicker();
                    updateUI();
                }
            }
            
            D.getElementById('pu-start-bonus').onclick = () => handlePrestigeUpgrade('pu-start-bonus', 'startBonus');
            D.getElementById('pu-cheaper-upgrades').onclick = () => handlePrestigeUpgrade('pu-cheaper-upgrades', 'cheaperUpgrades');
            D.getElementById('pu-prestige-boost').onclick = () => handlePrestigeUpgrade('pu-prestige-boost', 'prestigeBoost');
            D.getElementById('pu-autoclicker').onclick = () => handlePrestigeUpgrade('pu-autoclicker', 'autoclicker');

            D.getElementById('pu-base-cpc').onclick = () => {
                const cost = 1 + gameState.prestigeUpgrades.baseCpc;
                if (gameState.prestigePoints >= cost) {
                    gameState.prestigePoints -= cost;
                    gameState.prestigeUpgrades.baseCpc++;
                    updateUI();
                }
            };
            
            D.getElementById('set-nickname-btn').onclick = () => {
                const nick = D.getElementById('nickname-input').value.trim();
                if (nick) gameState.nickname = nick;
                saveGame();
            };

            D.getElementById('reset-btn').onclick = () => {
                if (confirm('Czy na pewno chcesz zresetować cały postęp? (Utracisz WSZYSTKO)')) {
                    if (autoclickerInterval) clearInterval(autoclickerInterval);
                    localStorage.removeItem('clickerGameSave');
                    window.location.reload();
                }
            };

            database.ref('leaderboard').orderByChild('c').limitToLast(10).on('value', snapshot => {
                const list = D.getElementById('leaderboard-list');
                list.innerHTML = ''; const scores = [];
                snapshot.forEach(child => { scores.push(child.val()) });
                scores.reverse().forEach(player => {
                    const li = D.createElement('li');
                    li.textContent = `${player.nn}: ${formatNumber(player.c)}`;
                    list.appendChild(li);
                });
            });

            loadGame();
            setInterval(saveGame, 30000); // Automatyczny zapis co 30 sekund
        });
    </script>
</body>
</html>
